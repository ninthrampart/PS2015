
@{
    ViewBag.Title = "Index";
}

<h2>Паспорт сделки</h2>

<script type="text/javascript">
    var app = new Backbone.Marionette.Application();

    var LayoutView = Backbone.Marionette.LayoutView.extend({
        template: "#layout_template",
        //el: 'body',

        regions: {
            mainRegion: "#ps_data"//,
            //secondoryRegion: "#content2",
            ////subRegion: "#subcontent",
            //detailsRegion: "#details_calc_record",
            //packSelectionRegion: "#simplepacklist"
        }
    });

    app.addRegions({
        startRegion: "#big_papa"
    });


    app.PS = Backbone.Model.extend({
        url: "/api/Passport/123"
    });

    app.BNSumList = Backbone.Model.extend({
        
    });

    app.BNSumLists = Backbone.Collection.extend({
        model: app.BNSumList,
        url: "/api/BN/Get/123"
    });

    PSView = Backbone.Marionette.ItemView.extend({
        template: "#ps_maininfo",
        className: 'ps_maininfo',
    });

    BNCountView = Backbone.Marionette.ItemView.extend({
        template: "#ps_bncountitem",
        tagName: 'tr',
        className: 'ps_bncountitem'
        
    });

    BNCountCollectionView = Backbone.Marionette.CompositeView.extend({
        template: "#ps_bncount",
        className: 'ps_bncount',
        childView: BNCountView,
        childViewContainer: "tbody"
    });

    app.addInitializer(function (options) {

        //alert("ok");
        //debugger;
        var cPS = options.passport;

        var subView = new PSView({
            model: cPS
        });

        //var bncountSubview = new BNCountView({

        //});
        var bnCountCollectionView = new BNCountCollectionView({
            collection: options.bnsumlists
        });

        var layout = new LayoutView();
        app.startRegion.show(layout);

        app.currLayout = layout;

        subView.render().$el.appendTo("#ps_data");
        bnCountCollectionView.render().$el.appendTo("#ps_data");
    });


    jQuery(document).ready(function () {

        var psId = '@(ViewBag.PsId)';
        @*alert('@ViewBag.OppId');*@
        
        app.ps = new app.PS({ id: psId });
        app.bnsumlists = new app.BNSumLists();

        //var complete = _.invoke([app.ps], 'fetch');

        //jQuery.when.apply(jQuery, complete).done(function () {
        //    alert("done");
        


        //debugger;
        //app.ps.fetch({
        //    async: false
        //});

        //debugger;

        //app.bnsumlists.fetch({
        //    async: false
        //});
        //debugger;

        //app.start({ passport: app.ps, bnsumlists: app.bnsumlists });

        //debugger;
        // фетч по 2м коллекциям одновременно - чтобы коллбек зарегистрировать
        var complete = _.invoke([app.ps, app.bnsumlists], 'fetch');

        

        //app.start({ currentPS: app.ps });

        //фетч завершен
        jQuery.when.apply(jQuery, complete).done(function () {           
            app.start({ passport: app.ps, bnsumlists: app.bnsumlists });

        });
    });
</script>

<div id="big_papa">

</div>


<script type="text/template" id="layout_template">
    <div id="ps_data">
    </div>
</script>

<script type="text/template" id="ps_maininfo">

    <div class="row">
        <div class="col-lg-7">

            <table class="table table-hover table-bordered">
                <thead>
                    <tr><th colspan="3">Основные показатели сделки</th></tr>
                </thead>
                <tr>
                    <td>Сумма по договору</td>
                    <td><span id="l_DealCost"><%- DealCost %> руб.</span></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Сумма сделки без НДС</td>
                    <td><span id="l_DealCost"> руб.</span></td>
                    <td></td>
                </tr>
                <tr style="border-bottom: 3px solid black">
                    <td>Бюджет исполнения</td>
                    <td><span id="dealimpl"><%- Buget %> руб.</span></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Маржа (средняя по сделке)</td>
                    <td><span id="l_marga"><%- Marga %> руб.</span></td>
                    <td><span id="l_marga_percent"><%- Marga_Percent %> %</span></td>
                </tr>
                <tr>
                    <td>Маржа ТМЦ, НПИ</td>
                    <td><span id="l_marga_vendor"><%- MargaVendor %> руб.</span></td>
                    <td><span id="l_marga_vendor_percent"><%- MargaVendor_Percent %> %</span></td>
                </tr>
                <tr>
                    <td>Маржа, работы</td>
                    <td><span id="l_marga_work"><%- MargaWork %> руб.</span></td>
                    <td><span id="l_marga_work_percent"><%- MargaWork_Percent %> %</span></td>
                </tr>
                <tr>
                    <td>Финансовый результат (средний по сделке)</td>
                    <td><span id="l_finres"><%- FinRes %> руб.</span></td>
                    <td><span id="l_finres_percent"><%- FinRes_Percent %> %</span></td>
                </tr>
                <tr>
                    <td>Плановая ПМП (средняя по сделке)</td>
                    <td><span id="l_finres"> руб.</span></td>
                    <td><span id="l_finres_percent"> %</span></td>
                </tr>
            </table>

        </div>
    </div>
</script>

<script type="text/template" id="ps_bncount">
    <div class="row">
        <div class="col-lg-7">
            <table id="tbl_ps_bncount" class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th colspan="7">Расчет по БН</th>
                    </tr>
                    <tr>
                        <th rowspan="2">Наименование БН</th>
                        <th rowspan="2">Сумма БН, руб.</th>
                        <th colspan="3">Маржа</th>
                        <th colspan="2">ПМП</th>
                    </tr>
                    <tr>
                        <th>Плановая, руб.</th>
                        <th>Плановая, %</th>
                        <th>Плановая с отсечкой, %</th>
                        <th>Плановая, руб.</th>
                        <th>Плановая, %</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</script>

<script type="text/template" id="ps_bncountitem">
    <td><%- BN %></td>
    <td><%- BNSumma %></td>
    <td><%- Marga %></td>
    <td><%- Original_Marga_Percent %></td>
    <td><%- Marga_Percent %></td>
    <td>-</td>
    <td>-</td>
</script>

